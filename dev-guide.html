<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>pixi-tools development</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>pixi-tools development</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>I recommend doing most development on a PC. The software compiles and runs
fine on a Linux PC (although obviously there&#8217;s no PiXi or Pi hardware to
talk to). The compile/edit cycle is much faster on a faster machine. If you
don&#8217;t have Linux installed on a PC, I suggest installing on a virtual
machine. A VirtualBox Debian installation would be ideal since it will most
closely match the Pi Raspbian installation. If not Debian, Ubuntu would be
a fairly close match.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_ssh">Configuring ssh</h2>
<div class="sectionbody">
<div class="paragraph"><p>It&#8217;s easier to use the Pi remotely if ssh is configured for login without
password login. There are various guides available on how to achieve that,
but here&#8217;s a brief guide. The following commands are run from the PC/VM.</p></div>
<div class="paragraph"><p>If you haven&#8217;t already done so, generate a ssh key, pressing [Enter] to
accept default settings:</p></div>
<div class="paragraph"><p><code>ssh-keygen</code></p></div>
<div class="paragraph"><p>Now copy the public key to remote-host:</p></div>
<div class="paragraph"><p><code>ssh-copy-id -i pi@192.168.2.6</code></p></div>
<div class="paragraph"><p>Type yes if it asks:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>The authenticity of host '192.168.2.6 (192.168.2.6)' can't be established.
ECDSA key fingerprint is xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx.
Are you sure you want to continue connecting (yes/no)? yes</code></pre>
</div></div>
<div class="paragraph"><p>Type the password when prompted. You should now be able to ssh without a password:</p></div>
<div class="paragraph"><p><code>ssh pi@192.168.2.6</code></p></div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start">Quick start</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following apt commands will need to be run as root.</p></div>
<div class="paragraph"><p>First, update package lists:</p></div>
<div class="paragraph"><p><code>apt-get update</code></p></div>
<div class="sect2">
<h3 id="_build_the_software">Build the software</h3>
<div class="paragraph"><p>The following raspbian packages are required:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
libi2c-dev
</dt>
<dd>
<p>
contains a replacement for the existing
/usr/include/linux/i2c-dev.h. This is needed for real i2c development.
</p>
</dd>
<dt class="hdlist1">
python-dev
</dt>
<dd>
<p>
required for building python extensions.
</p>
</dd>
<dt class="hdlist1">
swig
</dt>
<dd>
<p>
used to generate python extensions based on c-language declarations.
</p>
</dd>
<dt class="hdlist1">
libfuse-dev
</dt>
<dd>
<p>
required for the user-space UART implementation (which doesn&#8217;t work).
</p>
</dd>
</dl></div>
<div class="paragraph"><p>Install the packages:</p></div>
<div class="paragraph"><p><code>apt-get install libi2c-dev python-dev swig libfuse-dev</code></p></div>
<div class="paragraph"><p>Can now build the software, This takes about 2 minutes 30 seconds:</p></div>
<div class="paragraph"><p><code>make</code></p></div>
<div class="paragraph"><p>For comparison, on a desktop PC, with 4 CPU cores, <code>make -j4</code> takes less
than 3 seconds.</p></div>
</div>
<div class="sect2">
<h3 id="_build_the_source_documentation">Build the source documentation</h3>
<div class="paragraph"><p>More packages are required:</p></div>
<div class="paragraph"><p><code>apt-get install --no-install-recommends doxygen graphviz</code></p></div>
<div class="paragraph"><p>To build the source documentation (takes about 80 seconds):</p></div>
<div class="paragraph"><p><code>make doc</code></p></div>
<div class="paragraph"><p>The documentation will be found in
<em>build/release/share/pixi-tools/html/api/html/index.html</em>. It also packaged
in the .deb and is available at
<em>/usr/share/pixi-tools/html/api/html/index.html</em>. Those files are also
available remotely if you run the pixi-server web UI, but be aware that
pixi-server <em>cannot be considered secure</em>, although it should be safe enough
on a private home network.</p></div>
<div class="paragraph"><p>New developers should pay particular attention to the logging interface
module, since making good use of the logging infrastructure can save
substantial time in the long run.</p></div>
</div>
<div class="sect2">
<h3 id="_run_the_unit_tests">Run the unit tests</h3>
<div class="paragraph"><p>There&#8217;s a limited set of unit tests. There are currently a small set of
python based tests (which also test parts of libpixi), plus checks on the
public headers. Unfortunately, the unit tests require access to the pixi
hardware, which currently requires running the tests as the root user.</p></div>
<div class="paragraph"><p>Issue the following command. This takes around 22 seconds.</p></div>
<div class="paragraph"><p><code>make check</code></p></div>
</div>
<div class="sect2">
<h3 id="_build_the_deb_package">Build the .deb package</h3>
<div class="paragraph"><p>More raspbian packages are required. The following command will install
<code>devscripts</code> and many dependent packages:</p></div>
<div class="paragraph"><p><code>apt-get install devscripts</code></p></div>
<div class="paragraph"><p>To build deb, the git tree must be clean. Run the <code>git status</code> command.
Any changed files must be committed or reverted.
Any untracked files must be added and committed, or removed.</p></div>
<div class="paragraph"><p>The package build process runs a self contained build, then runs the unit
tests. Unfortunately, because the unit tests require running as root, the
package build currently must also run as root.</p></div>
<div class="paragraph"><p>The <code>make deb</code> command is used to build <em>official</em> packages for
distribution. It runs the tests and creates signed packages. There is an
alternative which will build without tests (so does not need to run as root)
and without signing:</p></div>
<div class="paragraph"><p><code>make deb-simple</code></p></div>
<div class="paragraph"><p>This can takes around 9 minutes (on a PC it takes a tiny fraction of
that). This will create the package files in the <em>parent</em> directory:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>-rw-r--r--  1 pi pi   19709 Jan 11 20:05 pixi-tools_0.6-1_armhf.build
-rw-r--r--  1 pi pi    2007 Jan 11 20:02 pixi-tools_0.6-1_armhf.changes
-rw-r--r--  1 pi pi 3033436 Jan 11 20:02 pixi-tools_0.6-1_armhf.deb
-rw-r--r--  1 pi pi    4570 Jan 11 19:56 pixi-tools_0.6-1.debian.tar.gz
-rw-r--r--  1 pi pi     785 Jan 11 19:56 pixi-tools_0.6-1.dsc
-rw-r--r--  1 pi pi  196028 Jan 11 19:56 pixi-tools_0.6.orig.tar.gz</code></pre>
</div></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_releasing_packages">Releasing packages</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_key_signing">Key signing</h3>
<div class="paragraph"><p>To release a package requires being able to sign the package. For details
refer to online guides, such as
<a href="https://wiki.debian.org/SettingUpSignedAptRepositoryWithReprepro">https://wiki.debian.org/SettingUpSignedAptRepositoryWithReprepro</a> and
<a href="https://wiki.debian.org/Keysigning">https://wiki.debian.org/Keysigning</a></p></div>
<div class="paragraph"><p>I recommend performing this procedure on a Linux PC or VM, then copying the
necessary files to the Pi. <a href="http://keyring.debian.org/creating-key.html">http://keyring.debian.org/creating-key.html</a>
provides a good guide to follow for generating the key. In summary, generate
the key:</p></div>
<div class="paragraph"><p><code>gpg --gen-key</code></p></div>
<div class="paragraph"><p>Choose <em>RSA and RSA</em>, 4096 bit length, <em>key does not expire</em>. Enter your
name and email address as it will appear in the package changelog etc. Enter
a memorable passphrase - the passphrase will be asked for when signing
packages. Follow the suggestions to generate some entropy (which can take a
fairly long time. Generating disk activity helps, by running something like
<code>find /usr/ -type f -print0 | xargs -0 cat &gt; /dev/null</code> in another
terminal, I was able to generate the key in about 5 minutes).</p></div>
<div class="paragraph"><p>Now to export the public key. You need the eight character hex ID. You can
list the keys with <code>gpg --list-keys</code>:</p></div>
<div class="literalblock">
<div class="content">
<pre><code>pixiuser@debianbox:~$ gpg --list-keys
/home/pixiuser/.gnupg/pubring.gpg
---------------------------------
pub   4096R/A12EDC9F 2015-01-12
uid                  Pixi User &lt;pixiuser@astro-designs.net&gt;
sub   4096R/38CE9CEB 2015-01-12</code></pre>
</div></div>
<div class="paragraph"><p><code>gpg --output pixiuser-key.gpg --armor --export A12EDC9F</code></p></div>
<div class="paragraph"><p>This creates the file pixiuser-key.gpg. This file can be imported by users
with the following command:</p></div>
<div class="paragraph"><p><code>apt-key add pixiuser-key.gpg</code></p></div>
<div class="paragraph"><p>but although hosting that key file somewhere is viable, it provides no
security if you host the key file in the same place as the apt
repository. There are suggestions detailed at
<a href="https://wiki.debian.org/Keysigning">https://wiki.debian.org/Keysigning</a> for using public keyservers. This should
be investigated.</p></div>
<div class="paragraph"><p>If the key generation was not run on the Pi, the simplest way to make the
keys available for signing packages generated on the Pi is to copy your
user&#8217;s .gnupg directory to the (root) user on the Pi.</p></div>
</div>
<div class="sect2">
<h3 id="_gpg_agent">gpg-agent</h3>
<div class="paragraph"><p>Every time you sign a file you have to enter the passphrase. Alternatively
you can run gpg-agent to reduce the number of times you have the enter the
passphrase. Install gpg-agent using <code>apt-get install gnupg-agent</code>. See <code>man
gpg-agent</code> for further instructions, but briefly, run this in the shell:</p></div>
<div class="paragraph"><p><code>eval $(gpg-agent --daemon)</code></p></div>
<div class="paragraph"><p>Now that shell has environment variables which tell child programs how to
access gpg-agent.</p></div>
</div>
<div class="sect2">
<h3 id="_preparing_the_package">Preparing the package</h3>
<div class="paragraph"><p>It&#8217;s generally worth running the tests using <code>make check</code> before attempting
to build the package.  After that, a new changelog entry must be created:</p></div>
<div class="paragraph"><p><code>dch</code></p></div>
<div class="paragraph"><p>This will generate a new changelog entry at the top of <em>debian/changelog</em>
and launch an editor for you to update it:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pixi-tools (0.6-1.1) UNRELEASED; urgency=low

  * Non-maintainer upload.
  *

 -- root &lt;root@raspberrypi&gt;  Mon, 12 Jan 2015 19:13:39 +0000

pixi-tools (0.6-1) unstable; urgency=medium

  * More i2c functions

  * More MPU functions, with fix for temperature representation</code></pre>
</div></div>
<div class="paragraph"><p>Edit the new entry: ensure the version is correct. The version number is in
two halves - software version and debian package version. In this case the
software version is 0.6 and needs to change to 0.6.1. The package version is
1.1 and needs to change to 1 (for a new software version package versions
always reset to 1), so change 0.6-1.1 to 0.6.1-1. Change <em>UNRELEASED</em> to
<em>unstable</em>. Change the user and email address to match that used in the GPG
key, then edit the changelog description:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pixi-tools (0.6.1-1) unstable; urgency=low

  * Example release for documentation.
    - No real changes
    - Just a bunch of text

 -- Pixi User &lt;pixiuser@astro-designs.net&gt;  Mon, 12 Jan 2015 19:13:39 +0000</code></pre>
</div></div>
<div class="paragraph"><p>Edit the version details in the project-info file. For this release, it
should look like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>PROJECT_NAME="pixi-tools"
PROJECT_VERSION="0.6.1"
LIBPIXI_VERSION_INT=0x000601</code></pre>
</div></div>
<div class="paragraph"><p>Run <code>make</code> to update the <em>libpixi/version.h</em> file. Use <code>git status</code> to
verify the changes:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>root@raspberrypi:/home/pi/pixi-tools# git status
# On branch pixi-tools
# Changes not staged for commit:
#   (use "git add &lt;file&gt;..." to update what will be committed)
#   (use "git checkout -- &lt;file&gt;..." to discard changes in working directory)
#
#       modified:   debian/changelog
#       modified:   libpixi/version.h
#       modified:   project-info
#</code></pre>
</div></div>
<div class="paragraph"><p>Commit these changes with a message that reflects the version update:
<code>git commit -a -m 'pixi-tools-0.6.1'</code></p></div>
<div class="paragraph"><p>It&#8217;s also necessary to tag the revision. github uses tags to signify source
releases. The build process uses the latest tag as the basis for the build
version. Without updating the tag, you get this result:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>root@raspberrypi:/home/pi/pixi-tools# make
make[1]: Entering directory '/home/pi/pixi-tools/build/release'
rm -f buildver-*
echo 0.6-3-g0fa1b40 &gt; buildver-0.6-3-g0fa1b40
echo '#define PIXI_TOOLS_BUILD_VERSION "0.6-3-g0fa1b40"' &gt; build-version.h
  CC      libpixi/pi/i2c.o</code></pre>
</div></div>
<div class="paragraph"><p>0.6-3-g0fa1b40 is the wrong version. Create an object tag with a message:</p></div>
<div class="paragraph"><p><code>git tag -m pixi-tools-0.6.1 pixi-tools-0.6.1</code></p></div>
<div class="paragraph"><p>(yes, the <em>pixi-tools-0.6.1</em> text appears twice in the command). Now the
build system will generate the correct version:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>make[1]: Entering directory '/home/pi/pixi-tools/build/release'
rm -f buildver-*
echo 0.6.1 &gt; buildver-0.6.1
echo '#define PIXI_TOOLS_BUILD_VERSION "0.6.1"' &gt; build-version.h
  CC      libpixi/pi/i2c.o</code></pre>
</div></div>
<div class="paragraph"><p>It&#8217;s now possible to build the package:</p></div>
<div class="paragraph"><p><code>make deb</code></p></div>
<div class="paragraph"><p>Near the end of the process you will be asked twice for the signing key
passphrase. Expect the process to take around 9 minutes. The result is a few
files in the parent directory:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>-rw-r--r--  1 root root   40851 Jan 12 19:41 pixi-tools_0.6.1-1_armhf.build
-rw-r--r--  1 root root    2458 Jan 12 19:41 pixi-tools_0.6.1-1_armhf.changes
-rw-r--r--  1 root root 3033562 Jan 12 19:38 pixi-tools_0.6.1-1_armhf.deb
-rw-r--r--  1 root root    4656 Jan 12 19:33 pixi-tools_0.6.1-1.debian.tar.gz
-rw-r--r--  1 root root    1683 Jan 12 19:41 pixi-tools_0.6.1-1.dsc
-rw-r--r--  1 root root  196089 Jan 12 19:32 pixi-tools_0.6.1.orig.tar.gz</code></pre>
</div></div>
<div class="paragraph"><p>If you&#8217;re happy with packaging, you can <code>git push</code> the latest changes to
github.</p></div>
</div>
<div class="sect2">
<h3 id="_preparing_the_repository">Preparing the repository</h3>
<div class="paragraph"><p>Unlike package generation, this process does not need to be performed on the
Pi. I recommend ensuring you run gpg-agent first. There are scripts in the
pixi-tools source <em>tools</em> directory to aid creating the repository
files. <code>create-repo</code> creates the configuration and <code>update-repo</code> updates the
packages.</p></div>
<div class="paragraph"><p><code>create-repo</code> takes two arguments. The first is the ID of your gpg public
key. The second is the name of the repository you are creating. It creates
configuration files in <em>conf/</em>. An example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pixiuser@debianbox:~/raspbian$ gpg --list-keys
/home/pixiuser/.gnupg/pubring.gpg
 ---------------------------------
pub   4096R/4B76B9DB 2015-01-12
uid                  Pixi User &lt;pixiuser@astro-designs.net&gt;
sub   4096R/D19AC571 2015-01-12

pixiuser@debianbox:~/raspbian$ ./create-repo 4B76B9DB "Astro Designs"

using 4B76B9DB as your gpg public key


Created conf/distributions:

Origin: Astro Designs
Label: Astro Designs
Codename: wheezy
Architectures: armhf source
Components: main
Description: Apt repository for Astro Designs
SignWith: 4B76B9DB


Created conf/options:

verbose
basedir /home/pixiuser/raspbian
ask-passphrase</code></pre>
</div></div>
<div class="paragraph"><p><code>update-repo</code> takes a single argument - the directory containing the
packages to add to the repository. When initially creating the repository on
your machine you need to include any existing packages in addition to new
packages, so alongside the new pixi-tools 0.6.1 .deb, we need the existing
pixi-fpga package. An example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pixiuser@debianbox:~/raspbian$ ./update-repo ../incoming
Processing files:
-rw-r--r-- 1 pixiuser pixiuser   98516 Jul  8  2014 ../incoming/pixi-fpga_0.2.1-1_all.deb
-rw-r--r-- 1 pixiuser pixiuser    1313 Jul  8  2014 ../incoming/pixi-fpga_0.2.1-1.dsc
-rw-r--r-- 1 pixiuser pixiuser 3033562 Jan 12 19:38 ../incoming/pixi-tools_0.6.1-1_armhf.deb
-rw-r--r-- 1 pixiuser pixiuser    1683 Jan 12 19:41 ../incoming/pixi-tools_0.6.1-1.dsc
Created directory "/home/pixiuser/raspbian/db"
../incoming/pixi-fpga_0.2.1-1_all.deb: component guessed as 'main'
Created directory "/home/pixiuser/raspbian/pool"
Created directory "/home/pixiuser/raspbian/pool/main"
Created directory "/home/pixiuser/raspbian/pool/main/p"
Created directory "/home/pixiuser/raspbian/pool/main/p/pixi-fpga"
Exporting indices...
Created directory "/home/pixiuser/raspbian/dists"
Created directory "/home/pixiuser/raspbian/dists/wheezy"
Created directory "/home/pixiuser/raspbian/dists/wheezy/main"
Created directory "/home/pixiuser/raspbian/dists/wheezy/main/binary-armhf"
Created directory "/home/pixiuser/raspbian/dists/wheezy/main/source"
Successfully created '/home/pixiuser/raspbian/dists/wheezy/Release.gpg.new'
Successfully created '/home/pixiuser/raspbian/dists/wheezy/InRelease.new'
../incoming/pixi-tools_0.6.1-1_armhf.deb: component guessed as 'main'
Created directory "/home/pixiuser/raspbian/pool/main/p/pixi-tools"
Exporting indices...
Successfully created '/home/pixiuser/raspbian/dists/wheezy/Release.gpg.new'
Successfully created '/home/pixiuser/raspbian/dists/wheezy/InRelease.new'
  100 %             636 B / 1,003 B = 0.634
  100 %                  32 B / 0 B &gt; 9.999
Local repository:
drwxr-xr-x 3 pixiuser pixiuser    4096 Jan 13 19:51 dists
drwxr-xr-x 3 pixiuser pixiuser    4096 Jan 13 19:51 dists/wheezy
-rw-r--r-- 1 pixiuser pixiuser    2424 Jan 13 19:51 dists/wheezy/InRelease
drwxr-xr-x 4 pixiuser pixiuser    4096 Jan 13 19:51 dists/wheezy/main
drwxr-xr-x 2 pixiuser pixiuser    4096 Jan 13 19:51 dists/wheezy/main/binary-armhf
-rw-r--r-- 1 pixiuser pixiuser    1003 Jan 13 19:51 dists/wheezy/main/binary-armhf/Packages
-rw-r--r-- 1 pixiuser pixiuser     554 Jan 13 19:51 dists/wheezy/main/binary-armhf/Packages.gz
-rw-r--r-- 1 pixiuser pixiuser     636 Jan 13 19:51 dists/wheezy/main/binary-armhf/Packages.xz
-rw-r--r-- 1 pixiuser pixiuser     125 Jan 13 19:51 dists/wheezy/main/binary-armhf/Release
drwxr-xr-x 2 pixiuser pixiuser    4096 Jan 13 19:51 dists/wheezy/main/source
-rw-r--r-- 1 pixiuser pixiuser     126 Jan 13 19:51 dists/wheezy/main/source/Release
-rw-r--r-- 1 pixiuser pixiuser      20 Jan 13 19:51 dists/wheezy/main/source/Sources.gz
-rw-r--r-- 1 pixiuser pixiuser      32 Jan 13 19:51 dists/wheezy/main/source/Sources.xz
-rw-r--r-- 1 pixiuser pixiuser    1558 Jan 13 19:51 dists/wheezy/Release
-rw-r--r-- 1 pixiuser pixiuser     819 Jan 13 19:51 dists/wheezy/Release.gpg
drwxr-xr-x 3 pixiuser pixiuser    4096 Jan 13 19:51 pool
drwxr-xr-x 3 pixiuser pixiuser    4096 Jan 13 19:51 pool/main
drwxr-xr-x 4 pixiuser pixiuser    4096 Jan 13 19:51 pool/main/p
drwxr-xr-x 2 pixiuser pixiuser    4096 Jan 13 19:51 pool/main/p/pixi-fpga
-rw-r--r-- 1 pixiuser pixiuser   98516 Jan 13 19:51 pool/main/p/pixi-fpga/pixi-fpga_0.2.1-1_all.deb
drwxr-xr-x 2 pixiuser pixiuser    4096 Jan 13 19:51 pool/main/p/pixi-tools
-rw-r--r-- 1 pixiuser pixiuser 3033562 Jan 13 19:51 pool/main/p/pixi-tools/pixi-tools_0.6.1-1_armhf.deb</code></pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_uploading_the_repository">Uploading the repository</h3>
<div class="paragraph"><p>The <em>pool</em> and <em>dists</em> directories need to be uploaded to the server.</p></div>
<div class="paragraph"><p><code>ncftpput</code> can be use to upload the repository (<code>apt-get install ncftp</code>):</p></div>
<div class="paragraph"><p><code>ncftpput -R -m -u &lt;username&gt; ftp.astro-designs.net raspbian dists pool</code></p></div>
<div class="paragraph"><p>but this will upload all files, whether or not they are new/changed. Some
more convenient procedure for synchronising with the server needs to be
found.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_build_structure">Build structure</h2>
<div class="sectionbody">
<div class="paragraph"><p>The build system is makefile based and requires GNU make. When starting a
build from the main source directory, the build actually runs from a
sub-directory of <em>build/</em>. For help type <code>make help</code>.</p></div>
<div class="paragraph"><p>Typing <code>make</code> for the first time creates a <em>build/release</em> sub-directory,
generates <em>build/release/Makefile</em>, then runs the main build from that
directory using that Makefile.</p></div>
<div class="paragraph"><p>Use <code>make BUILD_MODE=debug</code> to run a debug mode build in <em>build/debug</em>.</p></div>
<div class="paragraph"><p>Select a python version to build against by adding <code>PYTHON_VERSION=n</code>. When
a python version is specified, that will be added to the build sub-directory
name.</p></div>
<div class="paragraph"><p>Add <code>V=1</code> to make the build verbose.</p></div>
<div class="paragraph"><p>Putting it all together:</p></div>
<div class="paragraph"><p><code>make PYTHON_VERSION=3.3 BUILD_MODE=debug V=1</code></p></div>
<div class="paragraph"><p>This will run a verbose build in the <em>build/debug3.3/</em> sub-directory.</p></div>
<div class="paragraph"><p>The build structure is distributed across three makefiles:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
Makefile
</dt>
<dd>
<p>
The top level - generates the build configuration and manages
packaging of builds.
</p>
</dd>
<dt class="hdlist1">
Makefile.rules
</dt>
<dd>
<p>
Contains generic pattern rules.
</p>
</dd>
<dt class="hdlist1">
Makefile.build
</dt>
<dd>
<p>
Contains the main pixi-tools specific rules and
definitions.
</p>
</dd>
</dl></div>
<div class="paragraph"><p>In addition to the typical build structure reflecting the source tree
(i.e. <em>build/release/libpixi/pixi/gpio.o</em> is built from
<em>libpixi/pixi/gpio.c</em>), an approximation of the installation structure is
also built. <em>build/release/bin/pio</em> is generated, and also
<em>build/release/lib/libpixi.so</em> and <em>build/release/lib/libpixi.so.0</em>.</p></div>
<div class="paragraph"><p>Note that source/object files are not listed in the target definitions in
<em>Makefile.build</em>. Instead, all source files found in particular directories
are used for that particular target. For example, the <em>libpixi</em> related
declarations in <em>Makefile.build</em> do not list the libpixi source files, but
instead a search is done for all <em>.c</em> files found in <em>libpixi/</em>.</p></div>
<div class="paragraph"><p>Note also that Makefile.build contains the variable <code>libpixi_ABI</code>. This
variable defines the library major version number, and <strong>needs to be
incremented</strong> whenever the libpixi library ABI is changed in a way that
breaks compatibility with previously compiled applications. Otherwise you
may get silent breakage of third-party programs and (possibly) irate
users. Ideally the debian packages would be split up to allow previous ABI
versions to remain installed when newer ABI versions are released.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2015-01-17 10:38:51 GMT
</div>
</div>
</body>
</html>
